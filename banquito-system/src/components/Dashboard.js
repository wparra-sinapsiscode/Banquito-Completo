import React, { useState } from 'react';
import './Dashboard.css';
import LoansTable from './LoansTable';
import LoanRequest from './LoanRequest';
import MembersTable from './MembersTable';
import AdminPanel from './AdminPanel';
import Reports from './Reports';
import Settings from './Settings';
import Calendar from './Calendar';
import SavingsPlan from './SavingsPlan';
import TestComponent from './TestComponent';

const MemberLoansSection = ({ userLoans, getStatusInfo, formatCurrency }) => {
  const [currentPage, setCurrentPage] = useState(1);
  const [dateFilter, setDateFilter] = useState('all'); // all, recent, overdue
  const itemsPerPage = 5;

  const getFilteredLoans = () => {
    let filtered = [...userLoans];
    
    if (dateFilter === 'recent') {
      // Pr√©stamos de los √∫ltimos 30 d√≠as
      const thirtyDaysAgo = new Date();
      thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
      filtered = filtered.filter(loan => new Date(loan.startDate || loan.requestDate) >= thirtyDaysAgo);
    } else if (dateFilter === 'overdue') {
      // Solo pr√©stamos vencidos
      filtered = filtered.filter(loan => {
        const statusInfo = getStatusInfo(loan);
        return statusInfo.class === 'overdue';
      });
    } else if (dateFilter === 'current') {
      // Solo pr√©stamos al d√≠a
      filtered = filtered.filter(loan => {
        const statusInfo = getStatusInfo(loan);
        return statusInfo.class === 'current' || statusInfo.class === 'due-soon';
      });
    }
    
    return filtered;
  };

  const filteredLoans = getFilteredLoans();
  const totalPages = Math.ceil(filteredLoans.length / itemsPerPage);
  const startIndex = (currentPage - 1) * itemsPerPage;
  const currentLoans = filteredLoans.slice(startIndex, startIndex + itemsPerPage);

  const getNextWednesday = (date) => {
    // Manejar correctamente la zona horaria
    let d;
    if (typeof date === 'string' && date.includes('-')) {
      // Si es una fecha ISO string (YYYY-MM-DD), crear la fecha en hora local
      const [year, month, day] = date.split('T')[0].split('-').map(Number);
      d = new Date(year, month - 1, day, 12, 0, 0); // Usar mediod√≠a para evitar problemas de zona horaria
    } else {
      d = new Date(date);
    }
    
    const dayOfWeek = d.getDay();
    const nextDate = new Date(d);
    let daysToAdd;
    
    // Calcular d√≠as hasta el pr√≥ximo mi√©rcoles
    if (dayOfWeek < 3) {
      // Domingo (0), Lunes (1), Martes (2): calcular d√≠as hasta el mi√©rcoles
      daysToAdd = 3 - dayOfWeek;
    } else if (dayOfWeek === 3) {
      // Si es mi√©rcoles, ir al siguiente mi√©rcoles (7 d√≠as)
      daysToAdd = 7;
    } else {
      // Jueves (4), Viernes (5), S√°bado (6): calcular d√≠as hasta el pr√≥ximo mi√©rcoles
      daysToAdd = 10 - dayOfWeek;
    }
    
    nextDate.setDate(nextDate.getDate() + daysToAdd);
    return nextDate;
  };

  return (
    <>
      <div className="loans-header" style={{background:"#ffffff"}}>
        <h3>Filtrar Pr√©stamos</h3>
        <div className="loans-filters">
          <select 
            value={dateFilter} 
            onChange={(e) => {
              setDateFilter(e.target.value);
              setCurrentPage(1);
            }}
            className="date-filter"
          >
            <option value="all">üìã Todos los pr√©stamos</option>
            <option value="recent">üìÖ Recientes (30 d√≠as)</option>
            <option value="overdue">‚ö†Ô∏è Vencidos</option>
            <option value="current">‚úÖ Al d√≠a</option>
          </select>
        </div>
      </div>

      {currentLoans.length > 0 ? (
        <>
          <div className="loans-summary">
            {currentLoans.map(loan => {
              const progress = ((loan.originalAmount - loan.remainingAmount) / loan.originalAmount) * 100;
              const statusInfo = getStatusInfo(loan);
              const weeklyPayment = loan.weeklyPayment || loan.monthlyPayment || 0;
              
              return (
                <div key={loan.id} className="loan-summary-item">
                  <div className="loan-header">
                    <div className="loan-amount">
                      <span className="label">Monto original:</span>
                      <span className="value">S/ {formatCurrency(loan?.originalAmount || 0)}</span>
                    </div>
                    <div className={`status-indicator ${statusInfo.class}`}>
                      {statusInfo.icon} {statusInfo.label}
                    </div>
                  </div>
                  
                  <div className="loan-details">
                    <div className="detail-row">
                      <span className="label">Saldo pendiente:</span>
                      <span className="value">S/ {formatCurrency(loan?.remainingAmount || 0)}</span>
                    </div>
                    <div className="detail-row">
                      <span className="label">Pago semanal:</span>
                      <span className="value">S/ {Math.ceil(weeklyPayment)}</span>
                    </div>
                    {statusInfo.class === 'overdue' && (
                      <div className="detail-row overdue">
                        <span className="label">Total con mora:</span>
                        <span className="value">S/ {Math.ceil(weeklyPayment * 1.05)}</span>
                      </div>
                    )}
                  </div>
                  
                  <div className="loan-progress">
                    <div className="progress-bar">
                      <div 
                        className="progress-fill" 
                        style={{ width: `${progress}%` }}
                      ></div>
                    </div>
                    <div className="progress-info">
                      <span className="progress-text">{progress.toFixed(1)}% pagado</span>
                      <span className="weeks-text">
                        Semana {loan.currentWeek || loan.currentInstallment} de {loan.totalWeeks || loan.installments}
                      </span>
                    </div>
                  </div>
                  
                  <div className="next-payment-info">
                    <div className="payment-date">
                      <span className="label">Pr√≥ximo pago: </span>
                      <span className="value">
                        {new Date(loan.dueDate).toLocaleDateString('es-ES', { 
                          weekday: 'long', 
                          day: 'numeric', 
                          month: 'long' 
                        })}
                      </span>
                    </div>
                  </div>
                </div>
              );
            })}
          </div>
          
          {totalPages > 1 && (
            <div className="loans-pagination">
              <button 
                onClick={() => setCurrentPage(prev => Math.max(prev - 1, 1))}
                disabled={currentPage === 1}
                className="pagination-btn"
              >
                ‚Üê Anterior
              </button>
              <span className="pagination-info">
                P√°gina {currentPage} de {totalPages} ({filteredLoans.length} pr√©stamos)
              </span>
              <button 
                onClick={() => setCurrentPage(prev => Math.min(prev + 1, totalPages))}
                disabled={currentPage === totalPages}
                className="pagination-btn"
              >
                Siguiente ‚Üí
              </button>
            </div>
          )}
        </>
      ) : (
        <div className="no-data">
          {dateFilter === 'overdue' ? 'No tienes pr√©stamos vencidos' : 
           dateFilter === 'recent' ? 'No tienes pr√©stamos recientes' : 
           dateFilter === 'current' ? 'No tienes pr√©stamos al d√≠a' :
           'No tienes pr√©stamos activos'}
        </div>
      )}
    </>
  );
};

const MemberNotificationsSection = ({ userNotifications, formatCurrency }) => {
  const [notificationFilter, setNotificationFilter] = useState('all');
  
  const getFilteredNotifications = () => {
    let filtered = [...userNotifications];
    
    if (notificationFilter === 'approved') {
      filtered = filtered.filter(notification => notification.type === 'approved');
    } else if (notificationFilter === 'rejected') {
      filtered = filtered.filter(notification => notification.type === 'rejected');
    }
    
    return filtered;
  };

  const filteredNotifications = getFilteredNotifications();

  return (
    <>
      <div className="notifications-header">
        <h3>üîî Notificaciones</h3>
        <div className="notifications-filters">
          <select 
            value={notificationFilter} 
            onChange={(e) => setNotificationFilter(e.target.value)}
            className="notification-filter"
          >
            <option value="all">üìã Todas</option>
            <option value="approved">‚úÖ Aprobadas</option>
            <option value="rejected">‚ùå Rechazadas</option>
          </select>
        </div>
      </div>

      {filteredNotifications.length > 0 ? (
        <div className="notifications-list">
          {filteredNotifications.map(notification => (
            <div key={notification.id} className={`notification-item ${notification.type}`}>
              <div className="notification-header">
                <div className="notification-status">
                  {notification.type === 'approved' && (
                    <span className="status-badge approved">‚úÖ Solicitud Aprobada</span>
                  )}
                  {notification.type === 'rejected' && (
                    <span className="status-badge rejected">‚ùå Solicitud Rechazada</span>
                  )}
                </div>
                <div className="notification-date">
                  {new Date(notification.date).toLocaleDateString('es-ES')}
                </div>
              </div>
              
              <div className="notification-content">
                <div className="notification-message">{notification.message}</div>
                
                {notification.type === 'approved' && (
                  <div className="approval-details">
                    <div className="details-grid">
                      <div className="detail-card">
                        <div className="detail-icon">üí∞</div>
                        <div className="detail-info">
                          <span className="detail-label">Monto</span>
                          <span className="detail-value">S/ {formatCurrency(notification.amount || 0)}</span>
                        </div>
                      </div>
                      
                      <div className="detail-card">
                        <div className="detail-icon">üìÖ</div>
                        <div className="detail-info">
                          <span className="detail-label">Plazo</span>
                          <span className="detail-value">{notification.totalWeeks || notification.installments} semanas</span>
                        </div>
                      </div>
                      
                      <div className="detail-card">
                        <div className="detail-icon">üí≥</div>
                        <div className="detail-info">
                          <span className="detail-label">Pago Semanal</span>
                          <span className="detail-value">S/ {formatCurrency(notification.weeklyPayment || notification.monthlyPayment || 0)}</span>
                        </div>
                      </div>
                    </div>
                    
                    <div className="success-alert">
                      <div className="alert-icon">üéâ</div>
                      <div className="alert-content">
                        <strong>¬°Felicidades!</strong> Tu pr√©stamo ser√° procesado el pr√≥ximo mi√©rcoles (d√≠a de operaciones).
                      </div>
                    </div>
                  </div>
                )}
                
                {notification.type === 'rejected' && notification.reason && (
                  <div className="rejection-details">
                    <div className="rejection-reason">
                      <div className="reason-icon">üìù</div>
                      <div className="reason-content">
                        <span className="reason-label">Motivo del rechazo:</span>
                        <span className="reason-text">{notification.reason}</span>
                      </div>
                    </div>
                    
                    <div className="info-alert">
                      <div className="alert-icon">üí°</div>
                      <div className="alert-content">
                        Puedes realizar una nueva solicitud despu√©s de mejorar tu situaci√≥n crediticia.
                      </div>
                    </div>
                  </div>
                )}
              </div>
            </div>
          ))}
        </div>
      ) : (
        <div className="no-data">
          {notificationFilter === 'approved' ? 'No tienes solicitudes aprobadas' : 
           notificationFilter === 'rejected' ? 'No tienes solicitudes rechazadas' : 
           'No tienes notificaciones nuevas'}
        </div>
      )}
    </>
  );
};

const Dashboard = ({ 
  user, 
  loans, 
  setLoans, 
  loanRequests, 
  setLoanRequests, 
  members,
  setMembers,
  settings, 
  setSettings,
  calculateTotalCapital,
  calculateAvailableCapital,
  getBankingStatistics,
  getMonthlyInterestRate,
  calculateLateFee,
  getPaymentWithLateFee,
  users,
  setUsers 
}) => {
  const [activeTab, setActiveTab] = useState('dashboard');
  const [darkMode, setDarkMode] = useState(false);

  // Funci√≥n helper para formatear n√∫meros correctamente
  const formatCurrency = (value) => {
    // Limpiar el valor primero si es string con caracteres extra√±os
    let cleanValue = value;
    if (typeof value === 'string') {
      cleanValue = value.replace(/[^0-9.-]/g, '');
    }
    
    const num = parseFloat(cleanValue);
    if (isNaN(num)) return '0.00';
    
    // Formatear con separadores de miles y 2 decimales
    return num.toLocaleString('en-US', {
      minimumFractionDigits: 2,
      maximumFractionDigits: 2
    });
  };

  const getOverdueLoans = () => {
    const today = new Date();
    return loans.filter(loan => {
      const dueDate = new Date(loan.dueDate);
      return dueDate < today && loan.status !== 'paid';
    });
  };

  const getUpcomingPayments = () => {
    const today = new Date();
    const nextWeek = new Date(today.getTime() + 7 * 24 * 60 * 60 * 1000);
    
    return loans.filter(loan => {
      const dueDate = new Date(loan.dueDate);
      return dueDate >= today && dueDate <= nextWeek && loan.status !== 'paid';
    });
  };

  const getUserMember = () => {
    if (user.role === 'member' && user.memberId && members) {
      const member = members.find(member => member.id === user.memberId);
      console.log('üîç getUserMember - Buscando miembro con ID:', user.memberId);
      console.log('üîç getUserMember - Miembros disponibles:', members.length);
      console.log('üîç getUserMember - Miembro encontrado:', member);
      return member || null;
    }
    return null;
  };

  const getUserLoans = () => {
    if (user.role === 'member' && user.memberId) {
      // Solo pr√©stamos realmente activos (excluir solicitudes pendientes y rechazadas)
      const userActiveLoans = loans.filter(loan => 
        loan.memberId === user.memberId && 
        loan.status !== 'Por aprobar' && 
        loan.status !== 'Rechazada'
      );
      
      // DATOS PARA DASHBOARD
      const dashboardData = userActiveLoans.map(loan => ({
        seccion: 'DASHBOARD',
        nombre: loan.memberName,
        fechaVencimiento: loan.dueDate,
        montoOriginal: loan.originalAmount,
        montoPendiente: loan.remainingAmount,
        estado: loan.status,
        semanaActual: loan.currentWeek || loan.currentInstallment,
        totalSemanas: loan.totalWeeks || loan.installments
      }));
      
      // Guardar en window para comparaci√≥n
      window.dashboardLoansData = dashboardData;
      
      return userActiveLoans;
    }
    return [];
  };

  const getAllUserLoans = () => {
    if (user.role === 'member' && user.memberId) {
      // Todos los pr√©stamos del usuario (incluyendo solicitudes pendientes)
      return loans.filter(loan => loan.memberId === user.memberId);
    }
    return [];
  };

  const getUserNotifications = () => {
    if (user.role !== 'member' || !user.memberId) return [];
    
    const userRequests = loanRequests
      .filter(request => request.memberId === user.memberId)
      .filter(request => request.status === 'approved' || request.status === 'rejected');
    
    console.log('üîç User notifications - requests:', userRequests);
    
    return userRequests.map(request => ({
        id: request.id,
        type: request.status,
        title: request.status === 'approved' ? '‚úÖ Solicitud Aprobada' : '‚ùå Solicitud Rechazada',
        message: request.status === 'approved' 
          ? `Tu solicitud de pr√©stamo por S/ ${formatCurrency(request?.requestedAmount || 0)} ha sido aprobada.`
          : `Tu solicitud de pr√©stamo por S/ ${formatCurrency(request?.requestedAmount || 0)} ha sido rechazada.`,
        amount: request.requestedAmount,
        date: request.status === 'approved' ? request.approvalDate : request.rejectionDate,
        reason: request.rejectionReason || null,
        installments: request.installments,
        monthlyPayment: request.monthlyPayment,
        weeklyPayment: request.weeklyPayment,
        totalWeeks: request.totalWeeks
      }))
      .sort((a, b) => new Date(b.date) - new Date(a.date));
  };

  // Funci√≥n para calcular el pr√≥ximo mi√©rcoles
  const getNextWednesday = (date) => {
    // Manejar correctamente la zona horaria
    let d;
    if (typeof date === 'string' && date.includes('-')) {
      // Si es una fecha ISO string (YYYY-MM-DD), crear la fecha en hora local
      const [year, month, day] = date.split('T')[0].split('-').map(Number);
      d = new Date(year, month - 1, day, 12, 0, 0); // Usar mediod√≠a para evitar problemas de zona horaria
    } else {
      d = new Date(date);
    }
    
    const dayOfWeek = d.getDay(); // 0 = domingo, 3 = mi√©rcoles
    let daysToAdd;
    
    // Calcular d√≠as hasta el pr√≥ximo mi√©rcoles
    if (dayOfWeek < 3) {
      // Domingo (0), Lunes (1), Martes (2): calcular d√≠as hasta el mi√©rcoles
      daysToAdd = 3 - dayOfWeek;
    } else if (dayOfWeek === 3) {
      // Si es mi√©rcoles, ir al siguiente mi√©rcoles (7 d√≠as)
      daysToAdd = 7;
    } else {
      // Jueves (4), Viernes (5), S√°bado (6): calcular d√≠as hasta el pr√≥ximo mi√©rcoles
      daysToAdd = 10 - dayOfWeek;
    }
    
    const nextWednesday = new Date(d);
    nextWednesday.setDate(d.getDate() + daysToAdd);
    return nextWednesday;
  };

  const getStatusInfo = (loan) => {
    const today = new Date();
    const dueDate = new Date(loan.dueDate);
    const daysDiff = Math.floor((dueDate - today) / (1000 * 60 * 60 * 24));

    if (loan.status === 'paid') {
      return { label: 'Pagado', class: 'paid', icon: '‚óè' };
    } else if (daysDiff < 0) {
      return { label: `Vencido (${Math.abs(daysDiff)} d√≠as)`, class: 'overdue', icon: '‚óè' };
    } else if (daysDiff <= 3) {
      return { label: `Vence en ${daysDiff} d√≠as`, class: 'due-soon', icon: '‚óè' };
    } else {
      return { label: 'Al d√≠a', class: 'current', icon: '‚óè' };
    }
  };

  const renderDashboardContent = () => {
    const rawBankingStats = getBankingStatistics ? getBankingStatistics() : {
      totalCapital: calculateTotalCapital ? calculateTotalCapital() : 0,
      availableCapital: calculateAvailableCapital ? calculateAvailableCapital() : 0,
      capitalUtilization: 0,
      totalShares: 0,
      memberCount: members ? members.length : 0
    };
    
    console.log('üîç DEBUG Dashboard - rawBankingStats:', rawBankingStats);
    
    // Validar y limpiar los valores num√©ricos
    const bankingStats = {
      ...rawBankingStats,
      totalCapital: Number(String(rawBankingStats.totalCapital).replace(/[^0-9.-]/g, '')) || 0,
      availableCapital: Number(String(rawBankingStats.availableCapital).replace(/[^0-9.-]/g, '')) || 0,
      baseCapital: Number(String(rawBankingStats.baseCapital).replace(/[^0-9.-]/g, '')) || 0,
      loanedCapital: Number(String(rawBankingStats.loanedCapital).replace(/[^0-9.-]/g, '')) || 0,
      capitalUtilization: Number(String(rawBankingStats.capitalUtilization).replace(/[^0-9.-]/g, '')) || 0,
      profitMargin: Number(String(rawBankingStats.profitMargin).replace(/[^0-9.-]/g, '')) || 0
    };
    
    const totalCapital = bankingStats.totalCapital;
    const availableCapital = bankingStats.availableCapital;
    
    const overdueLoans = getOverdueLoans();
    const upcomingPayments = getUpcomingPayments();
    const userMember = getUserMember();
    const userLoans = getUserLoans();
    const userNotifications = getUserNotifications();

    return (
      <div className="dashboard-content">
        <div className="dashboard-header">
          <h2>
            {user.role === 'admin' && 'üìä Dashboard Administrativo'}
            {user.role === 'member' && 'üë§ Mi Dashboard'}
            {user.role === 'external' && 'üåê Portal Cliente Externo'}
          </h2>
          <div className="current-date">
            üìÖ {new Date().toLocaleDateString('es-ES', { 
              weekday: 'long', 
              year: 'numeric', 
              month: 'long', 
              day: 'numeric' 
            })}
          </div>
        </div>

        <div className={`stats-grid ${user.role === 'external' ? 'external-grid' : ''}`}>
          {user.role === 'admin' && (
            <>
              <div className="stat-card total">
                <div className="stat-icon">üí∞</div>
                <div className="stat-content">
                  <h3>Capital Total</h3>
                  <div className="stat-value">S/ {formatCurrency(totalCapital)}</div>
                  <div className="stat-subtitle">
                    Base: S/ {formatCurrency(bankingStats.baseCapital)}
                  </div>
                  <div className="stat-detail">
                    <div style={{ marginTop: '4px', fontWeight: 'bold', color: '#27ae60' }}>
                      üìà Rentabilidad: {formatCurrency(bankingStats.profitMargin)}%
                    </div>
                  </div>
                </div>
              </div>

              <div className="stat-card available">
                <div className="stat-icon">üíµ</div>
                <div className="stat-content">
                  <h3>Capital Disponible</h3>
                  <div className="stat-value">S/ {formatCurrency(availableCapital)}</div>
                  <div className="stat-subtitle">
                    {formatCurrency(bankingStats.capitalUtilization)}% en pr√©stamos
                  </div>
                  <div className="stat-detail">
                    Prestado: S/ {formatCurrency(bankingStats.loanedCapital)}
                  </div>
                </div>
              </div>

              <div className="stat-card loans">
                <div className="stat-icon">üìã</div>
                <div className="stat-content">
                  <h3>Pr√©stamos Activos</h3>
                  <div className="stat-value">{loans.filter(loan => loan.status !== 'paid').length}</div>
                  <div className="stat-subtitle">
                    S/ {formatCurrency(bankingStats.loanedCapital)} pendiente
                  </div>
                </div>
              </div>

              <div className="stat-card alerts">
                <div className="stat-icon">‚ö†Ô∏è</div>
                <div className="stat-content">
                  <h3>Alertas</h3>
                  <div className="stat-value">{overdueLoans.length}</div>
                  <div className="stat-subtitle">pr√©stamos vencidos</div>
                </div>
              </div>
            </>
          )}

          {user.role === 'member' && userMember && (
            <>
              <div className="stat-card member-info">
                <div className="stat-icon">üë§</div>
                <div className="stat-content">
                  <h3>Mi Informaci√≥n</h3>
                  <div className="stat-value">{userMember.name}</div>
                  <div className="stat-subtitle">
                    Calificaci√≥n: <span className={`credit-rating ${userMember.creditRating}`}>
                      {userMember.creditRating === 'green' && 'üü¢'}
                      {userMember.creditRating === 'yellow' && 'üü°'}
                      {userMember.creditRating === 'red' && 'üî¥'}
                    </span>
                  </div>
                </div>
              </div>

              <div className="stat-card guarantee">
                <div className="stat-icon">üèõÔ∏è</div>
                <div className="stat-content">
                  <h3>Mi Garant√≠a</h3>
                  <div className="stat-value">S/ {formatCurrency((userMember?.shares || 0) * (settings?.shareValue || 500))}</div>
                  <div className="stat-subtitle">{userMember?.shares || 0} acciones</div>
                </div>
              </div>

              <div className="stat-card my-loans">
                <div className="stat-icon">üí≥</div>
                <div className="stat-content">
                  <h3>Mis Pr√©stamos</h3>
                  <div className="stat-value">{userLoans.filter(loan => loan.status !== 'paid').length}</div>
                  <div className="stat-subtitle">
                    S/ {formatCurrency(userLoans.filter(loan => loan.status !== 'paid').reduce((sum, loan) => sum + parseFloat(loan.remainingAmount || 0), 0))} pendiente
                  </div>
                </div>
              </div>

              <div className="stat-card limit">
                <div className="stat-icon">üìä</div>
                <div className="stat-content">
                  <h3>L√≠mite Disponible</h3>
                  <div className="stat-value">
                    S/ {formatCurrency(Math.max(0, 
                      Math.min(
                        settings?.loanLimits?.individual || 8000, 
                        ((userMember?.shares || 0) * (settings?.shareValue || 500)) * 0.8
                      ) - userLoans.filter(loan => 
                        loan.status !== 'paid' && 
                        loan.status !== 'Rechazada' && 
                        loan.status !== 'Por aprobar'
                      ).reduce((sum, loan) => sum + parseFloat(loan.remainingAmount || 0), 0)
                    ))}
                  </div>
                  <div className="stat-subtitle">l√≠mite de pr√©stamo</div>
                </div>
              </div>
            </>
          )}

          {user.role === 'external' && (
            <>
              <div className="stat-card external-info">
                <div className="stat-icon">üèõÔ∏è</div>
                <div className="stat-content">
                  <h3>Sistema Banquito</h3>
                  <div className="stat-value">Pr√©stamos Asociativos</div>
                  <div className="stat-subtitle">Informaci√≥n p√∫blica</div>
                </div>
              </div>

              <div className="stat-card rates">
                <div className="stat-icon">üìà</div>
                <div className="stat-content">
                  <h3>Tasas de Inter√©s</h3>
                  <div className="stat-value">{settings?.monthlyInterestRates?.high || 3}% - {settings?.monthlyInterestRates?.low || 10}%</div>
                  <div className="stat-subtitle">mensual seg√∫n calificaci√≥n</div>
                </div>
              </div>

              <div className="stat-card guarantee">
                <div className="stat-icon">üí∞</div>
                <div className="stat-content">
                  <h3>Valor de Acciones</h3>
                  <div className="stat-value">S/ {settings?.shareValue || 500}</div>
                  <div className="stat-subtitle">por acci√≥n</div>
                </div>
              </div>

              <div className="stat-card limit">
                <div className="stat-icon">üìä</div>
                <div className="stat-content">
                  <h3>L√≠mite M√°ximo</h3>
                  <div className="stat-value">S/ {settings?.loanLimits?.maxAmount || 8000}</div>
                  <div className="stat-subtitle">por pr√©stamo</div>
                </div>
              </div>

              <div className="stat-card savings">
                <div className="stat-icon">üè¶</div>
                <div className="stat-content">
                  <h3>Plan de Ahorro</h3>
                  <div className="stat-value">2.00% TEA</div>
                  <div className="stat-subtitle">tasa efectiva anual</div>
                </div>
              </div>

              <div className="stat-card operation">
                <div className="stat-icon">üìÖ</div>
                <div className="stat-content">
                  <h3>D√≠a de Operaciones</h3>
                  <div className="stat-value">Mi√©rcoles</div>
                  <div className="stat-subtitle">pagos y desembolsos</div>
                </div>
              </div>
            </>
          )}
        </div>

        {user.role === 'admin' && (
          <div className="dashboard-sections">
            <div className="section upcoming-payments">
              <h3>üóìÔ∏è Pr√≥ximos Vencimientos (7 d√≠as)</h3>
              {upcomingPayments.length > 0 ? (
                <div className="payments-list">
                  {upcomingPayments.map(loan => (
                    <div key={loan.id} className="payment-item">
                      <div className="payment-member">{loan.memberName}</div>
                      <div className="payment-amount">S/ {formatCurrency(loan.weeklyPayment || loan.monthlyPayment || 0)}</div>
                      <div className="payment-date">{new Date(loan.dueDate).toLocaleDateString('es-ES')}</div>
                    </div>
                  ))}
                </div>
              ) : (
                <div className="no-data">No hay pagos pr√≥ximos en los siguientes 7 d√≠as</div>
              )}
            </div>

            <div className="section overdue-loans">
              <h3>‚ö†Ô∏è Pr√©stamos Vencidos</h3>
              {overdueLoans.length > 0 ? (
                <div className="overdue-list">
                  {overdueLoans.map(loan => (
                    <div key={loan.id} className="overdue-item">
                      <div className="overdue-member">{loan.memberName}</div>
                      <div className="overdue-amount">S/ {formatCurrency(loan.weeklyPayment || loan.monthlyPayment || 0)}</div>
                      <div className="overdue-days">
                        {Math.floor((new Date() - new Date(loan.dueDate)) / (1000 * 60 * 60 * 24))} d√≠as
                      </div>
                    </div>
                  ))}
                </div>
              ) : (
                <div className="no-data">‚úÖ No hay pr√©stamos vencidos</div>
              )}
            </div>
          </div>
        )}

        {user.role === 'member' && (
          <div className="dashboard-sections-member">
            <div className="loans-column">
              <div className="section my-loans-detail">
                <h3>üí≥ Mis Pr√©stamos Activos</h3>
                <MemberLoansSection 
                  userLoans={userLoans} 
                  getStatusInfo={getStatusInfo}
                  formatCurrency={formatCurrency}
                />
              </div>
            </div>

            <div className="notifications-column">
              {/* Secci√≥n de Notificaciones para Miembros */}
              <div className="section member-notifications">
                <MemberNotificationsSection 
                  userNotifications={userNotifications}
                  formatCurrency={formatCurrency}
                />
              </div>

              {/* Secci√≥n de Plan de Ahorro para Miembros */}
              <div className="section member-savings-plan">
                <h3>üí∞ Mi Plan de Ahorro a Plazo Fijo</h3>
                <div className="savings-plan-info">
                  <p className="savings-intro">
                    Haz crecer tu garant√≠a con nuestro plan de ahorro a plazo fijo con una TEA del 2%
                  </p>
                  <button 
                    className="view-savings-plan-btn"
                    onClick={() => {
                      console.log('üîç Bot√≥n Plan de Ahorro clickeado');
                      console.log('üîç Usuario actual:', user);
                      console.log('üîç Miembro actual:', getUserMember());
                      console.log('üîç Cambiando activeTab a: savings');
                      setActiveTab('savings');
                    }}
                  >
                    Ver Plan de Ahorro
                  </button>
                </div>
              </div>
            </div>
          </div>
        )}

        {user.role === 'external' && (
          <div className="dashboard-sections-external">
            <div className="section external-info">
              <h3>üèõÔ∏è ¬øC√≥mo funciona nuestro Banquito?</h3>
              <div className="info-content">
                <div className="info-card">
                  <h4>üí∞ Sistema de Garant√≠as</h4>
                  <p>Los miembros aportan acciones de S/ {settings?.shareValue || 500} cada una como garant√≠a. Pueden solicitar pr√©stamos hasta el 80% del valor de sus acciones.</p>
                </div>
                <div className="info-card">
                  <h4>üìä Calificaci√≥n Crediticia</h4>
                  <p>
                    <span className="rating-green">üü¢ Excelente:</span> {settings?.monthlyInterestRates?.high || 3}% mensual<br/>
                    <span className="rating-yellow">üü° Buena:</span> {settings?.monthlyInterestRates?.medium || 5}% mensual<br/>
                    <span className="rating-red">üî¥ Regular:</span> {settings?.monthlyInterestRates?.low || 10}% mensual
                  </p>
                </div>
                <div className="info-card">
                  <h4>üìÖ Proceso de Pr√©stamos</h4>
                  <p>Las solicitudes se procesan y desembolsan los mi√©rcoles (d√≠a de operaciones). Los pagos tambi√©n se reciben los mi√©rcoles de cada semana.</p>
                </div>
                <div className="info-card">
                  <h4>üè¶ Plan de Ahorro Fijo</h4>
                  <p>Ofrecemos planes de ahorro a plazo fijo de 90, 180 o 365 d√≠as con una TEA del 2.00%. El dinero es externo al capital del grupo.</p>
                </div>
              </div>
            </div>

            <div className="section external-calculator">
              <h3>üßÆ Simulador de Pr√©stamos</h3>
              <div className="calculator-content">
                <div className="calculator-example">
                  <h4>Ejemplo de Pr√©stamo:</h4>
                  <div className="example-data">
                    <div className="example-row">
                      <span>Monto solicitado:</span>
                      <span>S/ 3,000</span>
                    </div>
                    <div className="example-row">
                      <span>Plazo:</span>
                      <span>12 semanas</span>
                    </div>
                    <div className="example-row">
                      <span>Tasa (calificaci√≥n buena):</span>
                      <span>{settings?.monthlyInterestRates?.medium || 5}% mensual</span>
                    </div>
                    <div className="example-row highlight">
                      <span>Pago semanal aproximado:</span>
                      <span>S/ 275</span>
                    </div>
                    <div className="example-row">
                      <span>Total a pagar:</span>
                      <span>S/ 3,300</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div className="section external-requirements">
              <h3>üìã Requisitos para ser Miembro</h3>
              <div className="requirements-content">
                <div className="requirement-item">
                  <span className="requirement-icon">‚úÖ</span>
                  <span>Aportar m√≠nimo 1 acci√≥n (S/ {settings?.shareValue || 500})</span>
                </div>
                <div className="requirement-item">
                  <span className="requirement-icon">‚úÖ</span>
                  <span>Compromiso con los pagos semanales</span>
                </div>
                <div className="requirement-item">
                  <span className="requirement-icon">‚úÖ</span>
                  <span>Participaci√≥n en reuniones del grupo</span>
                </div>
                <div className="requirement-item">
                  <span className="requirement-icon">‚úÖ</span>
                  <span>Documentos de identidad v√°lidos</span>
                </div>
              </div>
            </div>
          </div>
        )}
      </div>
    );
  };

  const renderTabContent = () => {
    const userMember = getUserMember();
    
    console.log('üîç renderTabContent - activeTab:', activeTab);
    console.log('üîç renderTabContent - userMember:', userMember);
    console.log('üîç renderTabContent - user.role:', user.role);
    
    switch(activeTab) {
      case 'dashboard':
        return renderDashboardContent();
      case 'loans':
        return <LoansTable 
          loans={user.role === 'member' ? getUserLoans() : loans}
          setLoans={setLoans}
          userRole={user.role}
          currentUser={user}
          calculateLateFee={calculateLateFee}
          getPaymentWithLateFee={getPaymentWithLateFee}
        />;
      case 'request':
        return <LoanRequest 
          user={user}
          members={members}
          loans={loans}
          setLoans={setLoans}
          settings={settings}
          getMonthlyInterestRate={getMonthlyInterestRate}
          calculateAvailableCapital={calculateAvailableCapital}
          loanRequests={loanRequests}
          setLoanRequests={setLoanRequests}
          darkMode={darkMode}
        />;
      case 'members':
        return <MembersTable 
          members={members}
          setMembers={setMembers}
          settings={settings}
          darkMode={darkMode}
        />;
      case 'admin':
        return <AdminPanel 
          loanRequests={loanRequests}
          setLoanRequests={setLoanRequests}
          loans={loans}
          setLoans={setLoans}
          members={members}
          setMembers={setMembers}
          settings={settings}
          getPaymentWithLateFee={getPaymentWithLateFee}
        />;
      case 'reports':
        return <Reports loans={loans} members={members} darkMode={darkMode} />;
      case 'settings':
        return <Settings 
          settings={settings} 
          setSettings={setSettings} 
          loans={loans} 
          darkMode={darkMode}
          setDarkMode={setDarkMode}
        />;
      case 'calendar':
        return <Calendar 
          loans={loans} 
          loanRequests={loanRequests}
          members={members}
          onUpdateLoan={setLoans}
          onUpdateLoanRequest={setLoanRequests}
          currentUser={user}
          darkMode={darkMode}
          settings={settings}
        />;
      case 'savings':
        console.log('üí∞ CASE SAVINGS - Evaluando condiciones:');
        console.log('üí∞ user.role === member:', user.role === 'member');
        console.log('üí∞ userMember exists:', !!userMember);
        console.log('üí∞ userMember data:', userMember);
        
        if (user.role === 'member' && userMember) {
          console.log('üî• RENDERIZANDO SAVINGS PLAN');
          return <SavingsPlan 
            memberName={userMember.name}
            memberId={user.memberId}
            memberData={userMember}
            settings={settings}
            onSavingsUpdate={(savingsData) => {
              console.log('Nuevo plan de ahorro:', savingsData);
              // Aqu√≠ se podr√≠a guardar en el estado si es necesario
            }}
          />;
        }
        console.log('‚ö†Ô∏è NO se cumplen condiciones, renderizando dashboard');
        return renderDashboardContent();
      default:
        return renderDashboardContent();
    }
  };

  return (
    <div className={`dashboard-container ${darkMode ? 'dark' : ''}`}>
      {user.role !== 'external' && (
        <div className="dashboard-tabs">
        {(user.role === 'admin' || user.role === 'member') && (
          <button 
            className={`tab-btn ${activeTab === 'dashboard' ? 'active' : ''}`}
            onClick={() => setActiveTab('dashboard')}
          >
            Dashboard
          </button>
        )}
        
        {(user.role === 'admin' || user.role === 'member') && (
          <button 
            className={`tab-btn ${activeTab === 'loans' ? 'active' : ''}`}
            onClick={() => setActiveTab('loans')}
          >
            üí∞ Pr√©stamos
          </button>
        )}
        
        {user.role === 'member' && (
          <>
            <button 
              className={`tab-btn ${activeTab === 'request' ? 'active' : ''}`}
              onClick={() => setActiveTab('request')}
            >
              üìù Solicitar
            </button>
            <button 
              className={`tab-btn ${activeTab === 'savings' ? 'active' : ''}`}
              onClick={() => setActiveTab('savings')}
            >
              üí∞ Plan de Ahorro
            </button>
          </>
        )}
        
        {(user.role === 'admin' || user.role === 'member') && (
          <button 
            className={`tab-btn ${activeTab === 'calendar' ? 'active' : ''}`}
            onClick={() => setActiveTab('calendar')}
          >
            üìÖ Calendario
          </button>
        )}
        
        {user.role === 'admin' && (
          <>
            <button 
              className={`tab-btn ${activeTab === 'members' ? 'active' : ''}`}
              onClick={() => setActiveTab('members')}
            >
              üë• Miembros
            </button>
            <button 
              className={`tab-btn ${activeTab === 'admin' ? 'active' : ''}`}
              onClick={() => setActiveTab('admin')}
            >
              ‚öôÔ∏è Gesti√≥n
            </button>
            <button 
              className={`tab-btn ${activeTab === 'reports' ? 'active' : ''}`}
              onClick={() => setActiveTab('reports')}
            >
              üìà Reportes
            </button>
            <button 
              className={`tab-btn ${activeTab === 'settings' ? 'active' : ''}`}
              onClick={() => setActiveTab('settings')}
            >
              üîß Configuraci√≥n
            </button>
          </>
        )}
        </div>
      )}

      <div className={`dashboard-main ${darkMode ? 'dark' : ''}`}>
        {renderTabContent()}
      </div>
    </div>
  );
};

export default Dashboard;